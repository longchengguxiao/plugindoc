## 说在前面

!> 建议每一位使用者都阅读一下[AED功能的相关解释](#AED参数及返回结果解释)，以在危机之时争分夺秒渡过难关，谢谢

+ 请插件使用者仔细阅读此文档,确保能够正确理解命令。定时任务报错时会联系bot的superuser，因此一定要填好配置项才可以使用

+ 所有密码都经过**加密储存**，加密令牌可以[自定义](#自定义配置)，设置`DES_KEY`项。

!> 虽然对密码进行了加密处理，但是很遗憾，所有加密都是**可逆**的，如果不了解bot的主人请谨慎使用插件，**谨慎填写密码**。在进行功能订阅时可以回复'算了'或者'取消'来**取消本次操作**，或者在使用完功能后**及时取消订阅**该功能，以免造成不必要的损失

+ 请谨慎利用**记事本修改**数据保存的文件，这可能会导致插件运行出错

+ 在党的领导下**疫情时代已成为过去式**，晨午晚检打卡功能被封存

+ 对于插件问题可以提交issue或者pull_requests来进行交流

+ 对于本插件及本人下其他插件感兴趣的朋友可以添加QQ群聊（719392400）来对插件的发展给出建议以及测试

+ **用爱发电，请勿商用**

## 简介

Nonebot2插件，提供基础的西电校园服务，如课表提醒，体育打卡查询及提醒(暂未完善)，晨午晚检打卡和马原测试等功能。

## 安装

```buildoutcfg
从 nb_cli 安装
python -m nb_cli plugin install nonebot_plugin_xdu_support

或从 PyPI 安装
python -m pip install nonebot_plugin_xdu_support
```


## 使用

```buildoutcfg
在bot.py 中添加nonebot.load_plugin("nonebot_plugin_xdu_support")

以及配置好nonebot_plugin_apscheduler,否则定时任务无法顺利执行
```
配置部分可以参考[nonebot文档](https://v2.nonebot.dev/docs/advanced/scheduler)

## 详细玩法


> 通过使用关键字'xdu功能订阅'或'xdu服务订阅'来订阅插件功能
> 
> 通过关键字'xdu取消订阅'或'xdu服务退订'来解除订阅插件功能
>
> ~~通过关键字'晨午晚检查看'或'查看晨午晚检'来主动查看当前时间段是否完成晨午晚检~~
> 
> 通过关键字'学生健康信息查看'或'查看学生健康信息'来主动查看当前事件单是否完成学生健康信息填报
> 
> 通过关键字'体育打卡查看'或'查看体育打卡'来主动查看当前打卡次数
> 
> 通过关键字'课表查询'或'课表查看'来主动查看当天课表
> 
> 通过关键字'更新课表'来更新课表的本地缓存
> 
> 通过关键字'马原'(+空格+'单选'/'多选')来获取一道单选或者多选题，不加参数则为随机获取
> 
> 通过关键字'空闲教室查询'(+空格+地点(+空格+时间))来获取根据课表个性化的教室推荐
> 
> 通过关键字'AED'或'aed'来获取附近AED除颤仪的位置信息


## 命令详解

|  命令  |  格式（逗号分割）  |  命令样例（不需要引号）  |  返回和解释  |
|  ----  |  ----  |  ----  |  ----  |
|  功能订阅  | xdu功能订阅，xdu服务订阅 | 'xdu功能订阅' | 后续会提示输入订阅的功能以及对应的账号密码，该功能仅私聊可用 |
|  功能退订  | xdu功能退订，xdu取消订阅 | 'xdu取消订阅' | 后续提示输入退订的功能，该功能私聊群聊均可用 |
|  晨午晚检(**已失效**)  | 晨午晚检查看，查看晨午晚检 | '晨午晚检查看' | 主动返回当前时间段是否进行晨午晚检，订阅此服务即意味着每天的7,14,20点会进行一次打卡，目前仅支持南校区 |
|  学生健康信息  | 学生健康信息查看，查看学生健康信息 | '学生健康信息查看' | 主动返回当前日期是否进行学生健康信息填报，订阅此服务即每天8点进行一次学生健康信息填报 |
|  体育打卡  | 体育打卡查看，查看体育打卡 | '体育打卡查看' | 主动返回当前时刻的体育打卡有效次数，订阅此服务意味着会在系统收到第一次体育打卡信息的时候提醒你还有多久第二次打卡 |
|  课表提醒  | 课表查询，课表查看 | '课表查询' | 主动返回当天课表，订阅此服务即每天晚上22点推送第二天课表，每节课提前30分钟提醒下节课的信息 |
|  马原测试  | 马原(+空格+单选/多选) | '马原 单选' | 返回单选或多选题一道，可以通过参数指定，默认为随机。在作答完题目后还会返回正确率 |
|  空闲教室  | 空闲教室查询(+空格+教学楼(+空格+时间))| '空闲教室'或'空闲教室 B教学楼 2023-1-13'|返回根据当天课表给出的推荐教室，详细见下文，目前仅支持南校区|
|  AED查询  | AED，aed | 'AED' | 使用命令后根据提示发送位置信息，后获取附近的AED除颤仪信息，详细见下文，南北校区均支持，但不支持广研院 |

## 空闲教室参数及返回解释

+ 本功能针对看到许多教室，翻来覆去对比课程时间，较为麻烦的问题，本插件将查询空闲教室功能和个人课表相结合，每次返回不超过10个结果，并且给出相应的理由，大大减少了同学们选择自习教室的纠结程度。

?> 空闲教室功能可以包含两个参数 **地点**和**时间**。首次命令时可传入这两个参数，也可只传入地点，或均不传入

!>但是不能只传入时间，否则会导致报错

?> 地点目前仅支持南校区地点，其中包括：（以下地点在未传入参数时插件会有提示）

?> A教学楼,B教学楼,C教学楼,D教学楼,E教学楼I区,E教学楼II区,E教学楼III区,F教学楼,G教学楼,信远教学楼I区,信远教学楼II区,丁香1号书院,丁香2号书院12#,海棠八号书院,海棠九号书院,体育场,艺教中心,工训中心,行政辅楼,大学生活动中心,图书馆,实验室（排课）

!> 教学楼的名称自0.4.0版本后改为合并转发发送，用户可直接点开复制，避免浪费输入时间

!> 教学楼均通过测试，体育场等由于开放座位，因此不建议查询

?> ~~（v0.4.0前）时间需要按照格式`%Y-%m-%d`，即'2023-1-1'或者'2023-01-01'传入，可以不写零，此处通过`dateutil.parser`下的`parse`解析~~

?> 时间解析支持自然语言处理，可以用一些模糊时间，比如'本周三'或'下周四'

?> 在传入时间参数后插件会对比课表进行分析(此处如果之前没有缓存过本地课表会进行自动缓存，但还是建议先使用命令`更新课表`来手动更新缓存)

?> 如果当前选择教学楼在这天有课，则会根据上课教室选择最近的教室(尽量保证上课前后该教室均为空闲，以使得上课前和下课后均可以停留自习)

?> 如果当天有课，但是选择教学楼上没有课，则会提示切换教学楼可能会有更好的安排，但仍会在当前教学楼上进行推荐

?> 考虑到有同学询问并不是为了自习，而是活动举办等，因此所有情况下都会对当前教学楼空闲教室进行整理，选出空闲时间最多的五个进行提示。

!> 考虑到每次重复爬取对时间和硬件资源较为浪费，因此在首次查询该日期的空闲教室后进行储存，后续有相同查询即可直接调用，但这样导致的问题就是可能会有些**临时的加课**导致信息失效，如有麻烦请见谅。


## AED参数及返回结果解释

!> 关于AED

?> AED即自动体外除颤器，通常在发现患者有**心脏骤停**的情况时使用，主要用来终止室颤。由于大部分心脏骤停源于心室颤动，所以可应用AED使心脏骤停者**尽早恢复**正常心率，尽早使用能够**增加抢救的成功率**，以及**减少**心脏骤停导致的**死亡率**，能**最大限度**地恢复患者的脑、心脏等重要脏器功能。

!> AED除颤仪的使用方法

?> 当患者突然倒地失去反应，并失去呼吸或进入濒死喘息状态时，可打开AED并根据语音提示对患者进行急救，步骤包括：

?> 1、确认患者状态：包括是否失去反应、失去呼吸等；

?> 2、打开患者衣物裸露胸部，并根据标识将电极贴片贴在相应位置；

?> 3、AED分析心率：避免接触患者，以免干扰对心率的分析；

?> 4、当心率分析结果为室颤时，AED进行充电，充电完成后按下橙色按钮进行除颤，患者表现为全身瞬间抖动，之后需继续心肺复苏

!> 命令释义

?> 在使用命令`AED`后，会返回一条信息，指导你从手机版QQ来发送位置信息，即左下角'⊕'->'位置'->'发送位置'->右上角'发送'(没在配置项中填写SK则不会进行询问)

?> 在发送过位置信息后，机器人会进行解析，如果操作有无误则解析成功，获取你当前的经纬度坐标，然后匹配离你最近的AED除颤仪，将其位置作为终点由腾讯地图返回路径规划，插件返回AED距离，位置以及链接

?> 如果地址解析有误，则仅会返回推荐AED地点，通过再次发送需要选择要前往的地点，由腾讯地图返回地图标点，最终插件返回AED位置和链接

?> 若没有[填写SK](#自定义配置)，则仅返回文字版的推荐AED位置信息，无额外信息，因此推荐按照自定义配置来配置SK信息


## 更新

### v0.4.0

+ 2023/02/16 修复早八存在时无法查询的问题

+ 2023/02/15 优化空闲教室查询，日期支持自然语言处理（JioNLP）

+ 2023/02/12 疫情时代已经过去，晨午晚检已成为过去式，因此封存该部分功能

### v0.3.7

+ 2023/02/07 更新学生健康信息，由[@cyk1464](https://github.com/cyk1464) 提供脚本

### v0.3.5 

+ 2023/01/30 在返回附近AED信息后提示AED操作的相关步骤

### v0.3.0

+ 2023/01/30 更新AED查询功能，结合路径给出最佳选择

### v0.2.9

+ 2023/01/29 爆肝解决一切已知问题，根本难不倒我

### v0.2.2

+ 2023/01/29 新增空闲教室查询功能，结合课表进行优化

### v0.1.6

+ 2023/01/28 使用暂无问题，修复了mknod报错

### v0.1.0

+ 2023/01/28 基础功能基本实现，选课模块以及体育打卡补缺提上日程



## 自定义配置

```buildoutcfg
对Python编程比较熟悉的使用者可以在 .env 文件中设置XDU_SUPPORT_PATH来选择存储位置，不设置即为默认位置

设置 DES_KEY 来更改加密秘钥

将 appname 设置为你的应用名称，可以在腾讯地图开放平台申请并获取

将 SK 设置为你的secret_key，可以在腾讯地图开放平台申请并获取（需要和appname属于同一个应用）
```

!> 但要注意必须是**8位**的字符串，否则无法正常运行

## 特别感谢

感谢 [libxduauth](https://github.com/xdlinux/libxduauth) 项目提供模拟登陆

感谢 [xd_script](https://github.com/xdlinux/xidian-scripts) 项目提供参考，部分代码转化/改写自其中的脚本

感谢 [@cyk1464](https://github.com/cyk1464) 提供学生健康信息脚本

感谢 [JioNLP](https://github.com/dongrixinyu/JioNLP) 提供时间部分的自然语言处理服务